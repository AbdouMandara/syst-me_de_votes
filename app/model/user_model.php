<?php

class User{
private $connexion;

public function __construct()
{
    $this->connexion = require __DIR__ . '/../../config/database.php';   // RÃ©cupÃ¨re la connexion CAR on a retournÃ© dans database.php $connexion
}
/*---------Fonctions Ã  utiliser dans la classe---------------------- */
        //Fonction pour faciliter la sÃ©curisation des donnÃ©es et  pour sÃ©curisation de l'email
    private function securisation_entrÃ©e($donnÃ©e){
        $donnÃ©e = trim($donnÃ©e); // Supprimer les espaces en dÃ©but et fin de chaÃ®ne
        $donnÃ©e = stripslashes($donnÃ©e);
        $donnÃ©e = str_replace(["\\", "/"], "",$donnÃ©e); // Supprime tous les antislashs et slashs
        $donnÃ©e = strip_tags($donnÃ©e);
        return $donnÃ©e;
    }
    private function suppression_caracteres_speciaux_email($donnÃ©e) {
        $donnÃ©e = strip_tags($donnÃ©e);
        $donnÃ©e = preg_replace('/[^a-zA-Z0-9@._\-+]/', '', $donnÃ©e); // garde uniquement les caractÃ¨res autorisÃ©s
        return trim($donnÃ©e);
    }
    // !utilise filter_sanitize_email  pour sÃ©curiser et voir si la forme de l'email envoyÃ© est correcte
/*______________________________________________________________________ */

    public function inscription($nom, $password, $email){
        $nom = $this->securisation_entrÃ©e($nom);
        $password = $this->securisation_entrÃ©e($password);
        $email = $this->suppression_caracteres_speciaux_email($email);
        $password_hash = password_hash($password, PASSWORD_DEFAULT); //pour hasher le password donc coder le mot de passe entrÃ© en plusieurs autres caractÃ¨res
        $sql_insertion ='INSERT INTO user (nom, email, mot_de_passe) VALUES (:nom, :email, :mot_de_passe)';
        $requete_insertion = $this->connexion->prepare($sql_insertion); // Utilise $connexion
        $requete_insertion->execute([':nom' => $nom, ':mot_de_passe' => $password_hash, ':email' => $email]);
    }

    public function connexion ($email_user_connexion, $password_user_connexion){
        $sql_recherche='SELECT * FROM user  WHERE email= :email_user_connexion';
        $requete_recherche = $this->connexion->prepare($sql_recherche);
        $email_user_connexion = $this->suppression_caracteres_speciaux_email($email_user_connexion);
        $password_user_connexion = $this ->securisation_entrÃ©e($password_user_connexion);
        $requete_recherche->execute([':email_user_connexion'=>$email_user_connexion]);
        $user_trouvÃ©=$requete_recherche->fetch(PDO::FETCH_ASSOC); 

        if(!empty($user_trouvÃ©)){
            return $user_trouvÃ©;
        }else{
            return false;
        }
    }

    public function soumission_du_vote($user_id, $vote_id, $option_vote_id){
        $user_id_soumis=$user_id;
        $vote_id_soumis = $vote_id;
        $option_vote_id_soumis = $option_vote_id; 

        $sql_envoi_des_donnÃ©es_de_vote = 'INSERT INTO votes_utilisateur (user_id, vote_id, option_vote_id) VALUES (:user_id, :vote_id, :option_vote_id)';
        $requete_envoi_des_donnÃ©es_de_vote = $this->connexion->prepare($sql_envoi_des_donnÃ©es_de_vote);
        $requete_envoi_des_donnÃ©es_de_vote->execute([
            ':user_id'=>$user_id_soumis,
            ':vote_id'=>$vote_id_soumis,
            ':option_vote_id'=>$option_vote_id_soumis
        ]);
    }

    public function dÃ©jÃ _votÃ©($id_vote, $id_user){
        $sql_pour_voir_si_ce_user_a_dÃ©jÃ _votÃ© = "SELECT * FROM votes_utilisateur WHERE user_id = :user_id AND vote_id =:vote_id";
        $requete_pour_voir_si_ce_user_a_dÃ©jÃ _votÃ© = $this->connexion->prepare($sql_pour_voir_si_ce_user_a_dÃ©jÃ _votÃ©);
        $requete_pour_voir_si_ce_user_a_dÃ©jÃ _votÃ©->execute(["user_id"=> $id_user, "vote_id"=> $id_vote]);
        return $requete_pour_voir_si_ce_user_a_dÃ©jÃ _votÃ©->fetch(PDO::FETCH_ASSOC);
    }

    /**
     * Retourne un tableau d'IDs de votes dÃ©jÃ  soumis par un utilisateur.
     * Utile pour initialiser $_SESSION['votes'] lors de la connexion.
     * Retourne [] si aucun vote trouvÃ©.
     */
    public function votes_par_utilisateur($id_user){
        $sql_pour_trouver_vote_fait_par_user_connectÃ©= 'SELECT vote_id FROM votes_utilisateur WHERE user_id = :user_id';
        $requete_pour_trouver_vote_fait_par_user_connectÃ© = $this->connexion->prepare($sql_pour_trouver_vote_fait_par_user_connectÃ©);
        $requete_pour_trouver_vote_fait_par_user_connectÃ©->execute(['user_id' => $id_user]);
        $resultat_pour_trouver_vote_fait_par_user_connectÃ© = $requete_pour_trouver_vote_fait_par_user_connectÃ©->fetchAll(PDO::FETCH_ASSOC);

        // SI pas de vote on retourne un array vide []
        if (!$resultat_pour_trouver_vote_fait_par_user_connectÃ©) return [];
        // Si on trouve on stocke ce qu'on trouve dans le tableau des ids sous forme de int pour se rassurer ðŸ˜…
        $tableau_des_ids = [];
        foreach ($resultat_pour_trouver_vote_fait_par_user_connectÃ© as $resultat) {
            $tableau_des_ids[] = (int)$resultat['vote_id'];
        }
        // on retourne toutes les valeurs du tableau pour qu'il stocke celÃ  
        // Dans le controlleur Ã§a sera stockÃ© en occurence par $votes_user 
        return array_values($tableau_des_ids);
    }
}


class Admin{
    private $connexion;

    public function __construct()
    {
        $this->connexion = require __DIR__ . '/../../config/database.php';   // RÃ©cupÃ¨re la connexion CAR on a retournÃ© dans database.php $connexion
    }

    public function suppression_du_vote($id_du_vote_envoyÃ©){
        /*
        DELIMITER $$ 
        CREATE TRIGGER suppression_de_votes_effectuÃ©s_sur_ce_vote  
        BEFORE DELETE ON votes
        FOR EACH row
        BEGIN
             DELETE FROM votes_utilisateur WHERE vote_id= OLD.id;
        END $$
        DELIMITER ;

        DELIMITER $$ 
        CREATE TRIGGER suppression_des_options_de_ce_vote  
        BEFORE DELETE ON votes
        FOR EACH row
        BEGIN
             DELETE FROM option_votes WHERE vote_id= OLD.id;
        END $$
        DELIMITER ;
        */ //? J'execute d'ab ces triggers dans mon php My Admin
        $sql_suppression_du_vote = "DELETE FROM votes WHERE id = :id_du_vote";
        $requete_suppression_du_vote = $this->connexion->prepare($sql_suppression_du_vote);
        $requete_suppression_du_vote->execute(["id_du_vote" => $id_du_vote_envoyÃ©]);
    }

    // MÃ©thode si l'option 3 est indisponible
     public function ajout_du_vote_sans_option_3($titre_du_vote, $description_du_vote, $date_et_heure_fin_vote, $option_1_du_vote, $option_2_du_vote){

        $this->connexion->beginTransaction();

        $sql_pour_insÃ©rer_infos_du_vote ="INSERT INTO votes (titre, description, date_fin) VALUES (:titre_du_vote, :description_du_vote, :date_et_heure_fin_vote)";
        $requete_pour_insÃ©rer_infos_du_vote =$this->connexion->prepare($sql_pour_insÃ©rer_infos_du_vote);
        
        $requete_pour_insÃ©rer_infos_du_vote->execute([
            "titre_du_vote"=>$titre_du_vote,
            "description_du_vote"=>$description_du_vote,
            "date_et_heure_fin_vote"=>$date_et_heure_fin_vote
        ]);

        $vote_id = $this->connexion->lastInsertId();
        
        // SQL pour insÃ©rer les options 1 et 2
        $sql_pour_insÃ©rer_option_1_du_vote = "INSERT INTO option_votes (vote_id,libelle) VALUES (:vote_id, :option_1_du_vote)";
        $requete_pour_insÃ©rer_option_1_du_vote = $this->connexion->prepare($sql_pour_insÃ©rer_option_1_du_vote);
        
        $requete_pour_insÃ©rer_option_1_du_vote->execute([
            "vote_id"=>$vote_id,
            "option_1_du_vote" => $option_1_du_vote
        ]);

        $sql_pour_insÃ©rer_option_2_du_vote = "INSERT INTO option_votes (vote_id, libelle) VALUES (:vote_id, :option_2_du_vote)";
        $requete_pour_insÃ©rer_option_2_du_vote = $this->connexion->prepare($sql_pour_insÃ©rer_option_2_du_vote);
        
        $requete_pour_insÃ©rer_option_2_du_vote->execute([
            "vote_id"=>$vote_id,
            "option_2_du_vote" => $option_2_du_vote
        ]);
        $this->connexion->commit();
    }
    

    //MÃ©thode si l'option 3 est disponible
        public function ajout_du_vote_avec_option_3($titre_du_vote, $description_du_vote, $date_et_heure_fin_vote, $option_1_du_vote, $option_2_du_vote, $option_3_du_vote){
        try{
        $this->connexion->beginTransaction();

        $sql_pour_insÃ©rer_infos_du_vote ="INSERT INTO votes (titre, description, date_fin) VALUES (:titre_du_vote, :description_du_vote, :date_et_heure_fin_vote)";
        $requete_pour_insÃ©rer_infos_du_vote =$this->connexion->prepare($sql_pour_insÃ©rer_infos_du_vote);
        $requete_pour_insÃ©rer_infos_du_vote->execute(
        [
            "titre_du_vote"=>$titre_du_vote,
            "description_du_vote"=>$description_du_vote,
            "date_et_heure_fin_vote"=>$date_et_heure_fin_vote
        ]);
        /*
        DELIMITER $$
        CREATE TRIGGER recupere_id
        AFTER INSERT ON votes
        FOR EACH row
        BEGIN 
            INSERT INTO option_votes (vote_id) VALUES (NEW.id)
        END $$
        DELIMITER ;
        */

    // 2. RÃ©cupÃ©rer l'ID du dernier vote inserÃ©e
        $vote_id = $this->connexion->lastInsertId();

        $sql_pour_insÃ©rer_option_1_du_vote = "INSERT INTO option_votes (vote_id,libelle) VALUES (:vote_id, :option_1_du_vote)";
        $requete_pour_insÃ©rer_option_1_du_vote = $this->connexion->prepare($sql_pour_insÃ©rer_option_1_du_vote);
        $requete_pour_insÃ©rer_option_1_du_vote->execute([
            "vote_id"=>$vote_id,
            "option_1_du_vote" => $option_1_du_vote
        ]);

        $sql_pour_insÃ©rer_option_2_du_vote = "INSERT INTO option_votes (vote_id, libelle) VALUES (:vote_id, :option_2_du_vote)";
        $requete_pour_insÃ©rer_option_2_du_vote = $this->connexion->prepare($sql_pour_insÃ©rer_option_2_du_vote);
        $requete_pour_insÃ©rer_option_2_du_vote->execute([
            "vote_id"=>$vote_id,
            "option_2_du_vote" => $option_2_du_vote
        ]);
        
        $sql_pour_insÃ©rer_option_3_du_vote = "INSERT INTO option_votes (vote_id, libelle) VALUES (:vote_id, :option_3_du_vote)";
        $requete_pour_insÃ©rer_option_3_du_vote = $this->connexion->prepare($sql_pour_insÃ©rer_option_3_du_vote);
        $requete_pour_insÃ©rer_option_3_du_vote->execute([
            "vote_id"=>$vote_id,
            "option_3_du_vote" => $option_3_du_vote
        ]);
        
        $this->connexion->commit();
        } catch (Exception $e) {
       $this->connexion->rollBack();
       throw $e;
        }
    }

     //-Modification-  MÃ©thode si l'option 3 est indisponible 
     public function modification_du_vote_sans_option_3($id_du_vote,$titre_du_vote, $description_du_vote, $date_et_heure_fin_vote, $option_1_du_vote, $option_2_du_vote, $id_option_1_du_vote, $id_option_2_du_vote, $statut_du_vote ){

        // Nouvelle version : on attend les id des options en plus des libellÃ©s
        // $option_1_id et $option_2_id doivent Ãªtre transmis
        // $option_1_du_vote et $option_2_du_vote sont les nouveaux libellÃ©s
        // $this->connexion->beginTransaction();
        $sql_pour_modifier_infos_du_vote ="UPDATE  votes SET titre=:titre_du_vote, description =:description_du_vote, date_fin=:date_et_heure_fin_vote, statut_du_vote = :statut_du_vote WHERE id=:id_du_vote";
        $requete_pour_modifier_infos_du_vote =$this->connexion->prepare($sql_pour_modifier_infos_du_vote);
        $requete_pour_modifier_infos_du_vote->execute([
            "titre_du_vote"=>$titre_du_vote,
            "description_du_vote"=>$description_du_vote,
            "date_et_heure_fin_vote"=>$date_et_heure_fin_vote,
            "id_du_vote"=>$id_du_vote,
            "statut_du_vote"=>$statut_du_vote
        ]);

        // Modifier option 1
        $sql_pour_modifier_option_1_du_vote = "UPDATE option_votes SET libelle = :option_1_du_vote WHERE id = :option_1_id AND vote_id = :id_du_vote";
        $requete_pour_modifier_option_1_du_vote = $this->connexion->prepare($sql_pour_modifier_option_1_du_vote);
        $requete_pour_modifier_option_1_du_vote->execute([
            "option_1_du_vote" => $option_1_du_vote,
            "option_1_id" => $id_option_1_du_vote,
            "id_du_vote"=>$id_du_vote
        ]);

        // Modifier option 2
        $sql_pour_modifier_option_2_du_vote = "UPDATE option_votes SET libelle = :option_2_du_vote WHERE id = :option_2_id AND vote_id = :id_du_vote";
        $requete_pour_modifier_option_2_du_vote = $this->connexion->prepare($sql_pour_modifier_option_2_du_vote);
        $requete_pour_modifier_option_2_du_vote->execute([
            "option_2_du_vote" => $option_2_du_vote,
            "option_2_id" => $id_option_2_du_vote,
            "id_du_vote"=>$id_du_vote
        ]);
        // $this->connexion->commit();
    }
    

    //-Modification- MÃ©thode si l'option 3 est disponible
        public function modification_du_vote_avec_option_3($id_du_vote, $titre_du_vote, $description_du_vote, $date_et_heure_fin_vote, $option_1_du_vote, $option_2_du_vote, $option_3_du_vote, $id_option_1_du_vote, $id_option_2_du_vote, $id_option_3_du_vote){
        try{
        $sql_pour_modifier_infos_du_vote ="UPDATE  votes SET titre=:titre_du_vote, description =:description_du_vote, date_fin=:date_et_heure_fin_vote WHERE id=:id_du_vote";
        $requete_pour_modifier_infos_du_vote =$this->connexion->prepare($sql_pour_modifier_infos_du_vote);
        
        $requete_pour_modifier_infos_du_vote->execute([
            "titre_du_vote"=>$titre_du_vote,
            "description_du_vote"=>$description_du_vote,
            "date_et_heure_fin_vote"=>$date_et_heure_fin_vote,
            "id_du_vote"=>$id_du_vote,
        ]);

        
        // SQL pour insÃ©rer les options 1 et 2
        $sql_pour_modifier_option_1_du_vote = "UPDATE option_votes SET libelle = :option_1_du_vote WHERE vote_id = :id_du_vote";
        $requete_pour_modifier_option_1_du_vote = $this->connexion->prepare($sql_pour_modifier_option_1_du_vote);
        
        $requete_pour_modifier_option_1_du_vote->execute([
            "option_1_du_vote" => $option_1_du_vote,
            "option_1_id" => $id_option_1_du_vote,
            "id_du_vote"=>$id_du_vote
        ]);

        $sql_pour_modifier_option_2_du_vote = "UPDATE option_votes SET libelle = :option_2_du_vote WHERE vote_id = :id_du_vote";
        $requete_pour_modifier_option_2_du_vote = $this->connexion->prepare($sql_pour_modifier_option_2_du_vote);
        
        $requete_pour_modifier_option_2_du_vote->execute([
            "option_2_du_vote" => $option_2_du_vote,
            "option_2_id" => $id_option_2_du_vote,
            "id_du_vote"=>$id_du_vote
        ]);

        $sql_pour_modifier_option_3_du_vote = "UPDATE option_votes SET libelle = :option_3_du_vote WHERE vote_id = :id_du_vote";
        $requete_pour_modifier_option_3_du_vote = $this->connexion->prepare($sql_pour_modifier_option_3_du_vote);
        
        $requete_pour_modifier_option_3_du_vote->execute([
            "option_3_du_vote" => $option_3_du_vote,
            "option_3_id" => $id_option_3_du_vote,
            "id_du_vote"=>$id_du_vote
        ]);
        
        // $this->connexion->commit();
        } catch (Exception $e) {
       $this->connexion->rollBack();
       throw $e;
        }
    }

    }
?>